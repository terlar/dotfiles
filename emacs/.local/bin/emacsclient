#!/usr/bin/env bash
[[ "${TRACE}" ]] && set -x
set -eu
set -o pipefail

is_graphical() {
	[ -n "${DISPLAY:-}" ]
}

is_interactive() {
	fd=0 # stdin
	[ -t "${fd}" ] || [ -p /dev/stdin ]
}

has_xdotool() {
	command -v xdotool &>/dev/null
}

current_desktop() {
	xdotool get_desktop
}

bring_and_raise_window() {
	has_xdotool || return

	local wmname desktop
	wmname="${1?window name not provided}"
	desktop="$(current_desktop)"

	if [[ "${wmname}" = "editor" ]]
	then
		# I have still not found a way to actually raise the window to top if it
		# is already on the same desktop.
		xdotool	key 'Super+E'
	else
		xdotool search --name "${wmname}" set_desktop_for_window "${desktop}" windowactivate
	fi
}

has_window() {
	local wmname="${1?window name not provided}"

	xprop -name "${wmname}" &>/dev/null
}

main() {
	local raise=0
	local wmname="editor"

	while true
	do
		case "${1:-}" in
			-N | --name )
				wmname="$2"
				shift 2;;
			--name=?* )
				wmname="${1#*=}"
				shift 1;;
			--raise )
				raise=1
				shift 1;;
			-- )
				shift
				break;;
			* ) break;;
		esac
	done

	[[ $# -eq 0 ]] && is_interactive && raise=1

	if [[ "${raise}" = 1 ]] && is_graphical
	then
		# Open editor window if not available
		if has_window "${wmname}"
		then
			bring_and_raise_window "${wmname}"
		else
			/usr/bin/emacsclient \
				--no-wait \
				--create-frame \
				--frame-parameters="((name . \"${wmname}\"))" \
				"$@"
		fi

		[[ $# -eq 0 ]] && return 0
	fi

	exec /usr/bin/emacsclient "$@"
}

main "$@"
