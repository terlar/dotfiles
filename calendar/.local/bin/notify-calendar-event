#!/usr/bin/env bash
agenda() {
	khal agenda --days 1 | \
		sed -E -e 's|^([0-9]+:[0-9]+)-[0-9]+:[0-9]+: (.*)|\1 \2|' \
			-e 'tx' \
			-e 'd' \
			-e ':x'
}

is_within_notify_time() {
	local time="$1"
	local range="$2"

	now_ts=$(date '+%s')
	event_ts=$(date -d "$time" '+%s')
	alert_ts=$(( $event_ts - $range ))

	[[ "$now_ts" -lt "$event_ts" ]] && [[ "$now_ts" -gt "$alert_ts" ]]
}

main() {
	local time message
	agenda | while read event; do
		time=$(echo "$event" | cut -d ' ' -f 1)
		message=$(echo "$event" | cut -d ' ' -f 2-)

		is_within_notify_time "$time" 900 || continue

		notify-send "Event @ ${time}" "$message"
	done
}

main "$@"
