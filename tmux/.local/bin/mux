#!/usr/bin/env bash
set -e
set -o pipefail

unnamed_session() {
	if [[ -z "${TMUX}" ]]; then
		exec tmux attach || exec tmux new
	else
		exec tmux choose-session
	fi
}

named_session() {
	local session_name flags
	session_name="$1"
	shift 1

	flags=()

	while true ; do
		case "$1" in
			-c|-F|-n|-x|-y)
				flags+=("$1" "$2")
				shift 2
				;;
			*)
				break
				;;
		esac
	done

	if [[ -z "${TMUX}" ]]; then
		exec tmux new -A -s "${session_name}" \
		     "${flags[@]}" \
		     -- "$@"
	else
		if ! tmux has-session -t "${session_name}" 2>/dev/null; then
			tmux new -d -s "${session_name}" \
			     "${flags[@]}" \
			     -- "$@"
		fi

		exec tmux switch -t "${session_name}"
	fi
}

main() {
	if [[ "$#" -eq 0 ]]; then
		unnamed_session
	else
		named_session "$@"
	fi
}

main "$@"
