#!/usr/bin/env bash
set -eo pipefail

main() {
	if [[ $# -eq 0 ]]; then
		unnamed_session
	else
		named_session "$@"
	fi
}

unnamed_session() {
	if [[ -z "$TMUX" ]]; then
		exec tmux attach || exec tmux new
	else
		exec tmux choose-session
	fi
}

named_session() {
	declare session_name flags cmd
	session_name="$1"
	shift 1

	flags=()

	while true ; do
		case "$1" in
			-c|-F|-n|-x|-y)
				flags+=("$1" "$2")
				shift 2
			;;
			*)
				break
			;;
		esac
	done

	cmd="$@"

	if [[ -z "$TMUX" ]]; then
		exec tmux new -A -s "$session_name" ${flags[@]} $cmd
	else
		if ! tmux has-session -t "$session_name" 2>/dev/null; then
			tmux new -d -s "$session_name" ${flags[@]} $cmd
		fi

		exec tmux switch -t "$session_name"
	fi
}

main "$@"
