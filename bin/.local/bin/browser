#!/usr/bin/env bash
has_slack() {
	local cookie="$@"

	[[ -f "$cookie" ]]
}

is_slack_url() {
	local url="$@"

	[[ "$url" == https://*.slack.com/files/* ]]
}

is_youtube_url() {
	local url="$@"

	[[ "$url" == https://youtu.be/* || "$url" == https://www.youtube.com/watch* ]]
}

is_tumblr_url() {
	local url="$@"

	[[ "$url" == http://*.tumblr.com/* || "$url" == https://*.tumblr.com/* ]]
}

is_imgur_url() {
	local url="$@"

	[[ "$url" == http://imgur.com/* || "$url" == https://imgur.com/* ]]
}

is_not_empty() {
    local var=$1

    [[ -n $var ]]
}

main() {
	local browser='qutebrowser'
	local url
	local curl_opts='-Ls'
	local mpv_opts
	local slack_cookie="$HOME/.slackcurl/cookies"

	if [[ $# -eq 0 ]]; then
		if [[ -t 0 ]]; then
			exec $browser &>/dev/null
		else
			url=$(mktemp /tmp/browser.XXXXXXXX.html)
			cat /dev/stdin > $url
		fi
	else
		url="$*"
	fi

	if has_slack $slack_cookie && is_slack_url $url; then
		curl_opts="$curl_opts --cookie $slack_cookie"
		mpv_opts="$mpv_opts --cookies=yes --cookies-file $slack_cookie"
		local new_url=$(curl $curl_opts "$url" \
			| sed -e 's|boot_data.file = \({.*}\);|\1|;tx;d;:x' \
			| jq -r '.url_private_download')

		if [[ -n $new_url ]]; then
			url=$new_url
		fi
	elif is_tumblr_url $url; then
		local new_url=$(curl $curl_opts "$url" | sed -n '/<img/s/.*src="\([^"]*\)".*/\1/p' | grep -m1 '.gif$')

		if [[ -n $new_url ]]; then
			url=$new_url
		fi
	elif is_imgur_url $url; then
		url="${url/imgur.com/i.imgur.com}.png"
	fi

	local mime

	if is_youtube_url $url; then
		mime=video/youtube
	else
		mime=$(curl $curl_opts -r 0-499 -IX HEAD "$url" \
			| awk '/^Content-Type:/ { print $2 }' \
			| sed -e 's/[[:cntrl:]]//')
	fi


	is_not_empty $mime \
		&& echo "Detected $mime, loading..."

	case $mime in
		image/gif)
			exec curl $curl_opts $url | gifview -a -
			;;
		image/*)
			exec curl $curl_opts $url | feh -. -
			;;
		video/*)
			exec mpv $mpv_opts $url
			;;
		application/force-download)
			cd $XDG_DOWNLOAD_DIR
			curl $curl_opts -O $url
			cd -
			notify-send -i down 'File saved' "${XDG_DOWNLOAD_DIR}"
			;;
		*)
			exec $browser $url &>/dev/null
			;;
	esac
}

main "$@"
