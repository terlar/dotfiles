#!/usr/bin/env bash
set -e
set -o pipefail

has_cmd() {
	if command -v "$*" >/dev/null
	then
		return 0
	else
		return 1
	fi
}

pandoc_opts() {
	local opts=()

	local css_file="${HOME}/.local/share/pandoc/css/default.css"
	[[ -e "${css_file}" ]] && opts+=(-c "${css_file}")

	opts+=(-s)
	echo "${opts[@]}"
}

main() {
	local browser_cmd="${BROWSER}"

	while true
	do
		case "$1" in
			-n)
				browser_cmd="cat"
				shift 1
				;;
			*)
				break
				;;
		esac
	done

	local cmd
	local file="$*"
	local opts=()

	case "$file" in
		*.rst)
			has_cmd rst2html  && cmd="rst2html"
			has_cmd rst2html2 && cmd="rst2html2"
			has_cmd pandoc    && cmd="pandoc" opts=($(pandoc_opts))
			;;
		*.md)
			has_cmd marked && cmd="marked"
			has_cmd pandoc && cmd="pandoc" opts=($(pandoc_opts))
			;;
		*.html)
			cmd="cat"
			;;
	esac

	if [[ -z "${cmd}" ]]
	then
		cmd="awk"
		opts=(1 ORS="<br>")
	fi

	"${cmd}" "${opts[@]}" "${file}" | "${browser_cmd}"
}

main "$@"
